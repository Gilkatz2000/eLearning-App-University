{% extends "base.html" %}
{% block title %}Course Chat{% endblock %}
{% block content %}
<div class="chat-page">
  <h1 class="chat-title">Course Chat: {{ course.title }}</h1>

  <div class="chat-status">
    <strong>Status:</strong> <span id="chat-status">Connecting‚Ä¶</span>
  </div>

  <div id="chat-log" class="chat-log"></div>
  <form id="chat-form" class="chat-form">
    <input
      id="chat-message-input"
      class="chat-input"
      type="text"
      placeholder="Type a message..."
      autocomplete="off"
    >
    <button id="chat-send-btn" class="chat-send-btn" type="submit">
      Send
    </button>
  </form>

  <p class="chat-links">
    <a href="{% url 'course_detail' course.id %}">Back to course</a>
    <span class="chat-sep">|</span>
    <a href="{% url 'course_list' %}">Back to courses</a>
  </p>
</div>

<script>
  const courseId = "{{ course.id }}";
  const protocol = window.location.protocol === "https:" ? "wss" : "ws";
  const wsUrl = `${protocol}://${window.location.host}/ws/courses/${courseId}/chat/`;

  const log = document.getElementById("chat-log");
  const form = document.getElementById("chat-form");
  const input = document.getElementById("chat-message-input");
  const statusEl = document.getElementById("chat-status");
  const sendBtn = document.getElementById("chat-send-btn");

  function setStatus(text) {
    statusEl.textContent = text;
  }

  function addLine(line) {
    const p = document.createElement("p");
    p.className = "chat-line";
    p.textContent = line;
    log.appendChild(p);
    log.scrollTop = log.scrollHeight;
  }

  const chatSocket = new WebSocket(wsUrl);
  chatSocket.onopen = function() {
    setStatus("Connected");
    addLine("‚úÖ Connected to chat.");
    input.focus();
  };

  chatSocket.onmessage = function(e) {
    try {
      const data = JSON.parse(e.data);
      const ts = data.timestamp ? data.timestamp : "";
      const user = data.username ? data.username : "unknown";
      const msg = data.message ? data.message : "";
      addLine(`[${ts}] ${user}: ${msg}`);
    } catch (err) {
      addLine("‚ö†Ô∏è Received a message that could not be parsed.");
    }
  };

  chatSocket.onerror = function() {
    setStatus("‚ö†Ô∏è Error");
    addLine("‚ö†Ô∏è WebSocket error.");
  };

  chatSocket.onclose = function() {
    setStatus("üîå Disconnected");
    addLine("Disconnected from chat.");
    sendBtn.disabled = true;
    input.disabled = true;
  };

  form.addEventListener("submit", function(e) {
    e.preventDefault();

    if (chatSocket.readyState !== WebSocket.OPEN) {
      addLine("‚ö†Ô∏è Not connected. Refresh the page to reconnect.");
      return;
    }

    const message = input.value.trim();
    if (!message) return;

    chatSocket.send(JSON.stringify({ message }));
    input.value = "";
  });
</script>

{% endblock %}
