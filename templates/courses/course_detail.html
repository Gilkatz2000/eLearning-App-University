{% extends "base.html" %}
{% block title %}{{ course.title }}{% endblock %}
{% block content %}
<h1>{{ course.title }}</h1>

{% if course.description %}
  <p>{{ course.description }}</p>
{% endif %}

<p>
  <strong>Teacher:</strong>
  <a href="{% url 'user_home' course.teacher.username %}">
    {{ course.teacher.username }}
  </a>
  {% if course.teacher.first_name or course.teacher.last_name %}
    <span style="opacity: .8;">( {{ course.teacher.first_name }} {{ course.teacher.last_name }} )</span>
  {% endif %}
</p>

{% if avg_rating %}
  <p><strong>Average rating:</strong> {{ avg_rating|floatformat:1 }}/5</p>
{% else %}
  <p><strong>Average rating:</strong> <em>No feedback yet</em></p>
{% endif %}

{% if is_owner_teacher %}
  <div style="margin: 14px 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
    <strong>Teacher actions</strong>
    <ul style="margin: 8px 0 0 18px;">
      <li><a href="{% url 'upload_material' course.id %}">Upload material</a></li>
      <li><a href="{% url 'teacher_course_feedback' course.id %}">View feedback</a></li>
      <li><a href="{% url 'manage_enrollments' course.id %}">Manage students (block/remove)</a></li>
      <li><a href="{% url 'course_chat_room' course.id %}">Open course chat</a></li>
    </ul>
  </div>
{% endif %}

<hr>

<h2>Materials</h2>

{% if can_view_materials %}
  {% if materials %}
    <ul>
      {% for m in materials %}
        <li style="margin: 8px 0;">
          <a href="{% url 'download_material' course.id m.id %}">
            <strong>{{ m.title }}</strong>
          </a>
          <span style="opacity: .75;">â€” uploaded {{ m.uploaded_at|date:"Y-m-d H:i" }}</span>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p><em>No materials yet.</em></p>
  {% endif %}
{% else %}
  {% if user.is_authenticated and user.is_student and enrollment and enrollment.is_blocked %}
    <p style="opacity: .8;"><em>Materials are not available because you are blocked.</em></p>
  {% else %}
    <p style="opacity: .8;"><em>Materials are available only to enrolled students.</em></p>
  {% endif %}
{% endif %}

<hr>

{% if user.is_authenticated and user.is_student %}
  {% if enrollment %}
    {% if enrollment.is_blocked %}
      <p style="padding: 10px; border: 1px solid #f5c2c7; background: #f8d7da; border-radius: 8px;">
        <strong>You are blocked from this course.</strong>
      </p>
    {% else %}
      <p style="padding: 10px; border: 1px solid #cfe2ff; background: #e7f1ff; border-radius: 8px;">
        <strong>You are enrolled.</strong>
      </p>

      <p style="margin: 10px 0;">
        <a href="{% url 'course_chat_room' course.id %}">ðŸ’¬ Open course chat</a>
      </p>

      <h2>Leave feedback</h2>
      <p style="opacity: .8;">
        Your feedback helps the teacher improve the course.
      </p>

      <form method="post" action="{% url 'submit_feedback' course.id %}">
        {% csrf_token %}
        {{ feedback_form.as_p }}
        <button type="submit">
          {% if my_feedback %}Update feedback{% else %}Submit feedback{% endif %}
        </button>
      </form>
    {% endif %}
  {% else %}
    <form method="post" action="{% url 'enroll_course' course.id %}">
      {% csrf_token %}
      <button type="submit">Enroll</button>
    </form>
  {% endif %}
{% endif %}

<hr>

<h2>Recent feedback</h2>
{% if feedbacks %}
  <ul>
    {% for fb in feedbacks %}
      <li style="margin: 10px 0;">
        <strong>
          <a href="{% url 'user_home' fb.student.username %}">
            {{ fb.student.username }}
          </a>
        </strong>

        {% if fb.student.first_name or fb.student.last_name %}
          <span style="opacity: .8;">( {{ fb.student.first_name }} {{ fb.student.last_name }} )</span>
        {% endif %}

        <div style="opacity: .85;">Rating: {{ fb.rating }}/5</div>

        {% if fb.comment %}
          <div>{{ fb.comment }}</div>
        {% endif %}

        <small style="opacity: .7;">{{ fb.created_at|date:"Y-m-d H:i" }}</small>
      </li>
    {% endfor %}
  </ul>
{% else %}
  <p><em>No feedback yet.</em></p>
{% endif %}

<p><a href="{% url 'course_list' %}">Back to courses</a></p>

{% endblock %}
